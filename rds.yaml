AWSTemplateFormatVersion: '2010-09-09'
Description: 'RDS MySQL Instance with Auto-Generated Credentials - Student ID: 9015480'

Parameters:
  DBInstanceIdentifier:
    Description: 'Database instance identifier for Student 9015480'
    Type: String
    Default: 'assignment3-db-9015480'

  DBName:
    Description: 'Initial database name for Student 9015480'
    Type: String
    Default: 'assignment3'
    MinLength: 1
    MaxLength: 64

Resources:
  RDSCredentials:
    Type: 'AWS::SecretsManager::Secret'
    Properties:
      Name: 'rds-credentials-9015480'
      Description: 'Auto-generated RDS credentials for Student 9015480'
      GenerateSecretString:
        SecretStringTemplate: '{"username": "dbadmin9015480"}'
        GenerateStringKey: 'password'
        PasswordLength: 16
        ExcludeCharacters: '"@/\'
        IncludeSpace: false
        RequireEachIncludedType: true

  RDSSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: 'Security Group for RDS MySQL - Student 9015480'
      VpcId:
        Fn::ImportValue: 'Assignment3-VPC-ID-9015480'
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: 'Assignment3-RDS-SG-9015480'
        - Key: StudentID
          Value: '9015480'

  DBSubnetGroup:
    Type: 'AWS::RDS::DBSubnetGroup'
    Properties:
      DBSubnetGroupDescription: 'Subnet group for RDS - Student 9015480'
      SubnetIds:
        - Fn::ImportValue: 'Assignment3-PublicSubnet-ID-9015480'
      Tags:
        - Key: Name
          Value: 'Assignment3-DB-Subnet-Group-9015480'
        - Key: StudentID
          Value: '9015480'

  RDSInstance:
    Type: 'AWS::RDS::DBInstance'
    Properties:
      DBInstanceIdentifier: !Ref DBInstanceIdentifier
      DBName: !Ref DBName
      AllocatedStorage: '20'
      DBInstanceClass: 'db.t2.micro'
      Engine: 'mysql'
      EngineVersion: '5.7'
      MasterUsername: !GetAtt RDSCredentials.SecretValueFromJson.username
      MasterUserPassword: !GetAtt RDSCredentials.SecretValueFromJson.password
      VPCSecurityGroups:
        - !GetAtt RDSSecurityGroup.GroupId
      DBSubnetGroupName: !Ref DBSubnetGroup
      PubliclyAccessible: true
      MultiAZ: false
      StorageType: 'gp2'
      Tags:
        - Key: Name
          Value: 'Assignment3-RDS-9015480'
        - Key: StudentID
          Value: '9015480'

Outputs:
  DBEndpoint:
    Description: 'RDS Endpoint for Student 9015480'
    Value: !GetAtt RDSInstance.Endpoint.Address

  DBPort:
    Description: 'RDS Port for Student 9015480'
    Value: !GetAtt RDSInstance.Endpoint.Port

  DBSecretARN:
    Description: 'Secrets Manager ARN for credentials'
    Value: !Ref RDSCredentials